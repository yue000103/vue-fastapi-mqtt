# 液相色谱仪系统架构设计

## 📋 项目概述

基于现有Vue + FastAPI + MQTT实时采集系统，集成22个硬件设备，构建完整的液相色谱仪自动化控制系统。

### 硬件设备清单

#### 主机模块 (通过树莓派串口通信)
- **继电器控制**: 双2(低压电磁阀)、双1(高压电磁阀)、泵2(气泵)
- **压力传感器**: ttyAMA0接口，波特率9600
- **检测器**: ttyAMA3接口，波特率57600
- **四合一高压恒流泵**: ttyAMA2接口，波特率115200
- **气泡传感器**: 气1、气2、气3、气4 (4个传感器)

#### 收集模块 (通过IP地址HTTP通信)
- **LED灯控制**: 192.168.1.129/led/on
- **单个阀门控制**: 电1-电6、泵3、双3 (8个设备)
- **气泡传感器状态**: 气5、气6、气7 (3个传感器)
- **多向阀控制**: 多1-多11 (11个多向阀)
- **隔膜泵控制**: 泵4

---

## 🏗️ 整体系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Vue前端界面    │    │  FastAPI核心    │    │   硬件抽象层     │
│                │    │                │    │                │
│ ├─实时数据显示   │◄──►│ ├─MQTT服务      │◄──►│ ├─主机模块驱动   │
│ ├─设备控制面板   │    │ ├─RESTful API   │    │ ├─收集模块驱动   │
│ ├─流程管理      │    │ ├─设备管理器     │    │ ├─协议转换器     │
│ └─状态监控      │    │ └─数据处理器     │    │ └─错误处理器     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   数据存储层     │    │   物理硬件层     │
                       │                │    │                │
                       │ ├─SQLite数据库   │    │ ├─树莓派串口设备  │
                       │ ├─文件存储       │    │ ├─IP网络设备     │
                       │ ├─日志系统      │    │ ├─传感器群      │
                       │ └─文件存储      │    │ └─执行器群      │
                       └─────────────────┘    └─────────────────┘
```

---

## 📁 详细文件结构设计

### 前端架构 (Vue 3)
```
frontend/
├── src/
│   ├── views/                          # 页面视图
│   │   ├── Dashboard.vue               # 主仪表盘
│   │   ├── DeviceControl.vue           # 设备控制界面
│   │   ├── ChromatographyProcess.vue   # 色谱仪流程控制
│   │   ├── DataAnalysis.vue            # 数据分析界面
│   │   ├── SystemConfig.vue            # 系统配置界面
│   │   └── MaintenanceLog.vue          # 维护日志
│   │
│   ├── components/                     # 通用组件
│   │   ├── charts/                     # 图表组件
│   │   │   ├── RealtimeChart.vue       # 实时数据图表
│   │   │   ├── PressureChart.vue       # 压力曲线图
│   │   │   └── DetectorChart.vue       # 检测器信号图
│   │   ├── device-panels/              # 设备控制面板
│   │   │   ├── RelayPanel.vue          # 继电器控制面板
│   │   │   ├── PumpPanel.vue           # 泵控制面板
│   │   │   ├── ValvePanel.vue          # 阀门控制面板
│   │   │   ├── SensorPanel.vue         # 传感器状态面板
│   │   │   └── DetectorPanel.vue       # 检测器控制面板
│   │   ├── monitoring/                 # 监控组件
│   │   │   ├── SystemStatus.vue        # 系统状态
│   │   │   ├── AlarmPanel.vue          # 告警面板
│   │   │   └── LogViewer.vue           # 日志查看器
│   │   └── workflow/                   # 工作流组件
│   │       ├── ProcessSteps.vue        # 流程步骤
│   │       ├── MethodEditor.vue        # 方法编辑器
│   │       └── SampleQueue.vue         # 样品队列
│   │
│   ├── services/                       # 前端服务
│   │   ├── device-api.js               # 设备API服务
│   │   ├── mqtt-service.js             # MQTT通信服务
│   │   ├── data-service.js             # 数据处理服务
│   │   ├── workflow-service.js         # 工作流服务
│   │   └── config-service.js           # 配置管理服务
│   │
│   ├── store/                          # 状态管理
│   │   ├── modules/
│   │   │   ├── devices.js              # 设备状态
│   │   │   ├── workflow.js             # 工作流状态
│   │   │   └── realtime-data.js        # 实时数据
│   │   └── index.js
│   │
│   └── utils/                          # 工具函数
│       ├── device-utils.js             # 设备工具
│       ├── data-utils.js               # 数据处理工具
│       └── chart-utils.js              # 图表工具
```

### 后端架构 (FastAPI)
```
backend/
├── api/                                # API路由层
│   ├── __init__.py
│   ├── device_control.py               # 设备控制API
│   ├── data_collection.py              # 数据采集API
│   ├── system_management.py            # 系统管理API
│   ├── chromatography.py               # 色谱仪专用API
│   ├── workflow.py                     # 工作流API
│   └── maintenance.py                  # 维护管理API
│
├── services/                           # 业务服务层
│   ├── __init__.py
│   ├── device_manager.py               # 设备管理器
│   ├── data_processor.py               # 数据处理器
│   ├── workflow_engine.py              # 工作流引擎
│   ├── alert_manager.py                # 告警管理器
│   ├── method_manager.py               # 方法管理器
│   └── calibration_service.py          # 校准服务
│
├── models/                             # 数据模型
│   ├── __init__.py
│   ├── device_models.py                # 设备模型
│   ├── data_models.py                  # 数据模型
│   ├── config_models.py                # 配置模型
│   ├── workflow_models.py              # 工作流模型
│   └── result_models.py                # 结果模型
│
├── core/                               # 核心功能
│   ├── __init__.py
│   ├── mqtt_manager.py                 # MQTT管理器
│   ├── task_scheduler.py               # 任务调度器
│   ├── exception_handler.py            # 异常处理器
│   ├── security.py                     # 安全认证
│   └── database.py                     # 数据库连接
│
├── config/                             # 配置管理
│   ├── __init__.py
│   ├── settings.py                     # 应用配置
│   ├── device_config.py                # 设备配置
│   └── logging_config.py               # 日志配置
│
└── utils/                              # 工具函数
    ├── __init__.py
    ├── data_utils.py                   # 数据处理工具
    ├── device_utils.py                 # 设备工具
    └── validation.py                   # 数据验证
```

### 硬件抽象层
```
hardware/
├── host_devices/                       # 主机模块 (树莓派串口)
│   ├── __init__.py
│   ├── relay_controller.py             # 继电器控制器
│   │   └── RelayController类: 控制双2、双1、泵2
│   ├── pressure_sensor.py              # 压力传感器
│   │   └── PressureSensor类: ttyAMA0, 9600波特率
│   ├── detector.py                     # 检测器
│   │   └── DetectorController类: ttyAMA3, 57600波特率
│   ├── pump_controller.py              # 高压恒流泵
│   │   └── PumpController类: ttyAMA2, 115200波特率
│   └── bubble_sensor.py                # 气泡传感器
│       └── BubbleSensorHost类: 气1-气4传感器
│
├── collect_devices/                    # 收集模块 (IP网络)
│   ├── __init__.py
│   ├── led_controller.py               # LED灯控制
│   │   └── LEDController类: 192.168.1.129/led/on
│   ├── valve_controller.py             # 阀门控制器
│   │   └── ValveController类: 电1-电6、泵3、双3控制
│   ├── bubble_sensor_collect.py        # 气泡传感器状态
│   │   └── BubbleSensorCollect类: 气5-气7状态读取
│   ├── multi_valve.py                  # 多向阀控制
│   │   └── MultiValveController类: 多1-多11控制
│   └── pump_spray.py                   # 隔膜泵控制
│       └── SprayPumpController类: 泵4控制
│
├── drivers/                            # 底层驱动
│   ├── __init__.py
│   ├── serial_driver.py                # 串口驱动
│   │   ├── SerialPort类: 串口连接管理
│   │   └── SerialProtocol类: 串口协议封装
│   ├── http_driver.py                  # HTTP通信驱动
│   │   ├── HTTPClient类: HTTP请求封装
│   │   └── NetworkManager类: 网络连接管理
│   └── protocol_converter.py           # 协议转换器
│       ├── DataConverter类: 数据格式转换
│       └── CommandTranslator类: 命令翻译
│
├── interfaces/                         # 硬件接口
│   ├── __init__.py
│   ├── device_interface.py             # 设备通用接口
│   │   └── DeviceInterface抽象类
│   ├── sensor_interface.py             # 传感器接口
│   │   └── SensorInterface抽象类
│   └── actuator_interface.py           # 执行器接口
│       └── ActuatorInterface抽象类
│
└── tests/                              # 硬件测试
    ├── __init__.py
    ├── test_host_devices.py            # 主机设备测试
    ├── test_collect_devices.py         # 收集设备测试
    └── test_integration.py             # 集成测试
```

### 数据管理层
```
data/
├── database/                           # SQLite数据库
│   ├── migrations/                     # 数据库迁移脚本
│   ├── chromatography.db               # 主数据库文件
│   ├── schemas/                        # 数据库表结构
│   │   ├── device_config.sql           # 设备配置表
│   │   ├── sensor_data.sql             # 传感器数据表
│   │   ├── process_data.sql            # 过程数据表
│   │   ├── method_storage.sql          # 方法存储表
│   │   ├── user_management.sql         # 用户管理表
│   │   └── audit_logs.sql              # 审计日志表
│   └── backup/                         # 数据库备份
│       ├── daily/                      # 日备份
│       └── weekly/                     # 周备份
│
├── storage/                            # 文件存储
│   ├── logs/                           # 日志文件
│   │   ├── application/                # 应用日志
│   │   ├── device/                     # 设备日志
│   │   └── audit/                      # 审计日志
│   ├── configs/                        # 配置文件
│   │   ├── device_configs/             # 设备配置
│   │   ├── method_configs/             # 方法配置
│   │   └── system_configs/             # 系统配置
│   ├── exports/                        # 导出数据
│   │   ├── reports/                    # 报告文件
│   │   ├── data_exports/               # 数据导出
│   │   └── charts/                     # 图表导出
│   └── uploads/                        # 上传文件
│       ├── methods/                    # 方法文件
│       └── calibrations/               # 校准文件
│
└── backup/                             # 数据备份
    ├── daily/                          # 日备份
    ├── weekly/                         # 周备份
    └── monthly/                        # 月备份
```

---

## 🔧 核心模块设计

### 1. 设备管理器 (DeviceManager)
```python
class DeviceManager:
    """统一设备管理器"""
    def __init__(self):
        self.host_devices = {}          # 主机模块设备 (串口)
        self.collect_devices = {}       # 收集模块设备 (HTTP)
        self.device_status = {}         # 设备状态缓存
        self.communication_manager = CommunicationManager()

    async def initialize_devices(self):
        """初始化所有22个设备"""
        # 初始化主机模块设备 (5类)
        # 初始化收集模块设备 (17个)

    async def control_device(self, device_id: str, action: str, params: dict):
        """统一设备控制接口"""

    async def get_device_data(self, device_id: str):
        """获取设备实时数据"""

    async def monitor_devices(self):
        """持续监控所有设备状态"""

    async def calibrate_device(self, device_id: str, calibration_params: dict):
        """设备校准功能"""
```

### 2. 液相色谱仪工作流引擎
```python
class ChromatographyWorkflow:
    """液相色谱仪专用工作流引擎"""
    def __init__(self):
        self.workflow_steps = []
        self.current_step = 0
        self.device_manager = DeviceManager()

    async def run_sample_injection(self, sample_params: dict):
        """样品注入流程"""
        # 1. 检查系统压力
        # 2. 切换进样阀到LOAD位置
        # 3. 启动进样泵
        # 4. 切换进样阀到INJECT位置

    async def run_separation_process(self, method_params: dict):
        """分离过程控制"""
        # 1. 设置流动相组成
        # 2. 调节流速和压力
        # 3. 控制柱温
        # 4. 监控分离效果

    async def run_detection_cycle(self):
        """检测周期管理"""
        # 1. 配置检测器参数
        # 2. 开始数据采集
        # 3. 实时监控信号
        # 4. 数据处理和存储

    async def run_cleaning_procedure(self):
        """清洗程序"""
        # 1. 切换清洗溶剂
        # 2. 高流速冲洗管路
        # 3. 清洗进样器
        # 4. 系统预平衡
```

### 3. 多协议通信管理
```python
class CommunicationManager:
    """多协议通信管理器"""
    def __init__(self):
        self.serial_connections = {}    # 串口连接池
        self.http_sessions = {}         # HTTP会话池

    async def send_serial_command(self, port: str, command: bytes, baudrate: int):
        """串口命令发送"""
        # 支持ttyAMA0(9600), ttyAMA2(115200), ttyAMA3(57600)

    async def send_http_request(self, url: str, data: dict, method: str = "GET"):
        """HTTP请求发送"""
        # 支持192.168.1.129的各种接口

    async def read_sensor_data(self, device_type: str, device_id: str):
        """传感器数据读取"""

    async def control_actuator(self, device_type: str, device_id: str, action: dict):
        """执行器控制"""
```

### 4. 实时数据流处理
```python
class DataStreamProcessor:
    """实时数据流处理器"""
    def __init__(self):
        self.mqtt_publisher = MQTTPublisher()
        self.data_buffer = {}
        self.processors = {
            'pressure': self.process_pressure_data,
            'detector': self.process_detector_data,
            'bubble': self.process_bubble_data,
        }

    async def process_sensor_data(self, device_id: str, raw_data: bytes):
        """传感器数据处理"""

    async def process_pressure_data(self, raw_data: bytes):
        """压力传感器数据处理"""

    async def process_detector_data(self, raw_data: bytes):
        """检测器信号处理"""

    async def process_bubble_data(self, raw_data: str):
        """气泡传感器数据处理"""

    async def publish_realtime_data(self, processed_data: dict):
        """发布实时数据到MQTT"""
        topics = {
            'pressure': 'chromatography/pressure',
            'detector': 'chromatography/detector',
            'bubble': 'chromatography/bubble',
            'flow': 'chromatography/flow',
        }
```

---

## 📊 数据流程设计

### 实时数据流
```
[传感器] → [硬件驱动] → [数据处理器] → [MQTT发布] → [前端显示]
    ↓           ↓            ↓
[设备日志] → [SQLite数据库] → [数据分析]
```

### 控制指令流
```
[前端界面] → [API接口] → [设备管理器] → [硬件驱动] → [物理设备]
    ↓           ↓           ↓
[操作日志] → [审计记录] → [状态反馈]
```

---

## 🚀 关键特性

### 1. 设备抽象化
- 22个硬件设备统一接口
- 串口和HTTP双协议支持
- 自动设备发现和状态监控

### 2. 实时性保证
- 基于MQTT的实时数据传输
- 微秒级传感器数据采集
- 实时图表和状态更新

### 3. 工作流自动化
- 可配置的色谱分析流程
- 自动样品处理队列
- 智能错误恢复机制

### 4. 数据完整性
- SQLite数据库存储
- 完整的操作审计日志
- 数据备份和恢复

### 5. 扩展性设计
- 模块化硬件驱动
- 插件化工作流步骤
- RESTful API接口

---

## 🔍 技术栈选型

### 前端技术栈
- **Vue 3** + Composition API
- **Chart.js** / **ECharts** - 实时数据可视化
- **Element Plus** - UI组件库
- **Pinia** - 状态管理
- **MQTT.js** - MQTT客户端

### 后端技术栈
- **FastAPI** - 高性能API框架
- **Pydantic** - 数据验证和序列化
- **SQLAlchemy** - ORM框架
- **Celery** - 异步任务队列
- **paho-mqtt** - MQTT客户端
- **pyserial** - 串口通信

### 数据存储
- **SQLite** - 轻量级关系数据库，文件存储，零配置
- **JSON文件** - 配置和缓存数据存储
- **CSV/TXT** - 数据导出和日志文件

### 通信协议
- **MQTT** - 实时消息传输
- **HTTP/WebSocket** - API通信
- **Serial/RS485** - 硬件设备通信

---

## 📈 性能指标

### 实时性要求
- 传感器数据采集频率: ≤100ms
- MQTT消息延迟: ≤50ms
- 前端图表更新频率: ≤200ms
- 设备控制响应时间: ≤500ms

### 可靠性要求
- 系统可用性: ≥99.5%
- 数据完整性: 100%
- 自动故障恢复: ≤30s
- 设备通信成功率: ≥99%

### 扩展性要求
- 支持设备数量: 100+个
- 并发用户数: 10+个
- 数据存储周期: 1年+
- API响应能力: 1000+请求/分钟

---

此架构设计充分利用了现有的Vue+FastAPI+MQTT基础设施，通过分层设计和模块化开发，可以高效地集成22个硬件设备，构建完整的液相色谱仪自动化控制系统。